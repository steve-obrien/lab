<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>AI Call Interface</title>
		<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
		<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
	</head>

	<body class="bg-gray-100 text-gray-900">
		<div class="flex">
			<div id="app">
				<call-logs></call-logs>
			</div>
			<div class="w-[300px] p-4">

				<h1 class="text-3xl font-bold mb-4">AI Call Interface</h1>
				<p class="mb-4">Enter a phone number to make a call:</p>
				<form id="callForm" class="bg-white p-6 rounded shadow-md">
					<select id="instructionFiles" class="w-full p-2 border border-gray-300 rounded mb-4">
						<option value="new">New...</option>
						<!-- Options will be populated dynamically -->
					</select>
					<textarea id="instructions" rows="5" placeholder="AI instructions" class="w-full p-2 border border-gray-300 rounded mb-4"></textarea><br>
					<input value="07969088447" type="text" id="phoneNumber" placeholder="Enter phone number" required class="w-full p-2 border border-gray-300 rounded mb-4">
					<button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Make Call</button>
					<button type="button" id="saveButton" class="bg-green-500 text-white px-4 py-2 rounded ml-2">Save</button>
				</form>

				<h2 class="text-2xl font-bold mt-8">API Endpoints</h2>
				<p class="mb-4">Below are the available API endpoints for this service:</p>
				<ul class="list-disc list-inside">
					<li><strong>GET /</strong> - Displays this UI and documentation.</li>
					<li><strong>POST /make-call</strong> - Initiates a call to the specified phone number.</li>
					<li><strong>GET /token</strong> - Generates a Twilio Client token.</li>
					<li><strong>POST /incoming-call</strong> - Handles incoming calls with TwiML response.</li>
					<li><strong>POST /outbound-call</strong> - Handles outbound calls with TwiML response.</li>
					<li><strong>GET /media-stream</strong> - WebSocket route for media streaming.</li>
				</ul>
			</div>
		</div>

		<script>
			async function fetchInstructionFiles() {
				const response = await fetch('/instructions');
				const files = await response.json();
				const dropdown = document.getElementById('instructionFiles');
				files.forEach(file => {
					const option = document.createElement('option');
					option.value = file.name;
					option.textContent = file.name;
					dropdown.appendChild(option);
				});
			}

			document.getElementById('instructionFiles').addEventListener('change', async (event) => {
				const selectedFile = event.target.value;
				if (selectedFile === 'new') {
					document.getElementById('instructions').value = '';
				} else {
					const response = await fetch("/instructions/" + selectedFile);
					const data = await response.json();
					console.log(data);
					document.getElementById('instructions').value = data.instructions;
				}
			});

			document.getElementById('saveButton').addEventListener('click', async () => {
				const selectedFile = document.getElementById('instructionFiles').value;
				const instructions = document.getElementById('instructions').value;
				let fileName = selectedFile;

				if (selectedFile === 'new') {
					fileName = prompt('Enter a file name for the new instructions:');
					if (!fileName) return; // Exit if no file name is provided
				}

				try {
					const response = await fetch("/save-instructions", {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ fileName, instructions })
					});
					const result = await response.json();
					alert(result.message || 'Instructions saved');
				} catch (error) {
					alert('Failed to save instructions');
				}
			});

			document.getElementById('callForm').addEventListener('submit', async (event) => {
				event.preventDefault(); // Prevent form submission

				const phoneNumber = document.getElementById('phoneNumber').value;
				const instructions = document.getElementById('instructions').value;

				try {
					const response = await fetch('/make-call', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ to: phoneNumber, instructions })
					});

					const result = await response.json();
					alert(result.message || 'Call initiated');
				} catch (error) {
					alert('Failed to initiate call');
				}
			});

			fetchInstructionFiles();


			const { createApp, ref, onMounted } = Vue;

			const CallLogs = {
				template: `
					<div class="bg-white p-6 rounded shadow-md mt-8">
						<h2 class="text-2xl font-bold mb-4">Call Logs</h2>
						<div class="h-64 overflow-y-auto border border-gray-300 p-4">
							<div v-for="(log, index) in logs" :key="index" class="mb-2">
							{{ log }}
							</div>
						</div>
					</div>
				`,
				setup() {
					const logs = ref([]);

					const connectWebSocket = () => {
						const socket = new WebSocket('ws://your_server_address/ws/logs');

						socket.onmessage = (event) => {
							logs.value.push(event.data);
						};

						socket.onerror = (error) => {
							console.error('WebSocket Error: ', error);
						};

						socket.onclose = () => {
							console.log('WebSocket connection closed. Reconnecting in 5 seconds...');
							setTimeout(connectWebSocket, 5000);
						};
					};

					onMounted(() => {
					//	connectWebSocket();
					});

					return { logs };
				}
			};

			createApp({
				components: { CallLogs }
			}).mount('#app');



		</script>
	</body>

</html>